<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Registrations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-900 to-gray-700 text-gray-100 p-4 sm:p-6 md:p-8">
  <div class="max-w-7xl mx-auto space-y-6">
    <header class="flex flex-col sm:flex-row items-center justify-between bg-gray-800/80 backdrop-blur-sm rounded-xl py-4 px-4 sm:px-6 shadow-lg">
      <h1 class="text-2xl sm:text-3xl font-bold text-amber-400 tracking-tight mb-4 sm:mb-0">
        Registrations Dashboard
      </h1>
      <div class="flex items-center gap-3 sm:gap-4">
        <button id="toggleBtn" class="px-4 sm:px-5 py-2 bg-amber-500 text-gray-900 font-semibold rounded-full hover:bg-amber-400 transition-all duration-300 shadow-md text-sm sm:text-base">
          Show Verified Users
        </button>
        <button onclick="logout()" class="flex items-center gap-2 px-4 sm:px-5 py-2 bg-red-600 text-white font-semibold rounded-full hover:bg-red-500 transition-all duration-300 shadow-md text-sm sm:text-base">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="flex justify-between items-center mb-6 px-4">
      <div id="totalCount" class="text-base sm:text-lg font-semibold text-amber-300">
       
      </div>
    </div>

    <div id="contentWrapper" class="space-y-6"></div>
  </div>

  <script>
    const hdr = () => {
      const tok = localStorage.getItem('sms_admin_creds');
      return tok ? { Authorization: `Basic ${tok}` } : {};
    };

    const field = (k, v) => `
      <tr class="divide-x divide-gray-600 hover:bg-gray-700/50 transition-colors">
        <td class="py-2 sm:py-3 px-3 sm:px-5 font-medium text-gray-300 text-sm sm:text-base">${k}</td>
        <td class="py-2 sm:py-3 px-3 sm:px-5 text-gray-100 break-all text-sm sm:text-base">${v ?? '-'}</td>
      </tr>`;

    let isShowingVerified = false;

    async function load(showVerified = isShowingVerified) {
      isShowingVerified = showVerified;
      const toggleBtn = document.getElementById('toggleBtn');
      toggleBtn.textContent = showVerified ? 'Registrations' : 'Active Users';

      const url = showVerified ? '/admin/verified-users' : '/admin/data';
      const r = await fetch(url, { headers: hdr() });
      if (r.status === 401) return (location.href = '/admin/login');

      const data = await r.json();
      const totalCount = showVerified ? `Total Verified Users: ${data.length}` : `Total Registrations: ${data.length}`;
      document.getElementById('totalCount').textContent = totalCount;
      
      const wrap = document.getElementById('contentWrapper');
      if (!data.length) {
        wrap.innerHTML = `<p class="text-center text-gray-400 text-base sm:text-lg">
          ${showVerified ? 'No verified users found.' : 'No registrations yet.'}</p>`;
        return;
      }

      wrap.innerHTML = data.map(rec => {
        const P = {
          'Full Name': rec.fullName, 'Role': rec.role, 'Address': rec.address,
          'Email': rec.email, 'Phone': rec.phone, 'Citizen Doc': rec.citizenDoc
        };
        const I = {
          'Institute': rec.institutionName, 'Type': rec.institutionType, 'PAN / VAT': rec.panVat,
          'Address': rec.institutionAddress, 'Email': rec.institutionEmail,
          'Contact': rec.institutionContact, 'Additional': rec.additionalInfo
        };
        const date = new Date(rec.createdAt || parseInt(rec._id.slice(0, 8), 16) * 1000).toLocaleString();

        let extraContent = '';
        if (showVerified) {
          extraContent = `
            <div class="p-4 sm:p-6 border-t border-gray-600">
              <h4 class="font-semibold text-amber-400 mb-3 text-sm sm:text-base">Login Credentials</h4>
              <ul class="ml-4 list-disc text-xs sm:text-sm text-gray-200">
                <li><strong>Institute ID:</strong> ${rec.credentials?.instituteId ?? '-'}</li>
                <li><strong>Super Admin ID:</strong> ${rec.credentials?.superAdminId ?? '-'}</li>
                <li><strong>Password:</strong> ${rec.credentials?.password ?? '-'}</li>
              </ul>
            </div>`;
        } else {
          extraContent = `
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 p-4 sm:p-6 border-t border-gray-600">
              <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-full bg-green-600 hover:bg-green-500 text-white text-xs sm:text-sm font-semibold transition-all"
                      onclick="verifyReg('${rec._id}')"><i class="fas fa-check"></i> Verify</button>
              <button class="flex items-center justify-center gap-2 px-4 py-2 rounded-full bg-red-600 hover:bg-red-500 text-white text-xs sm:text-sm font-semibold transition-all"
                      onclick="openDeleteModal('${rec._id}')"><i class="fas fa-trash"></i> Remove</button>
            </div>`;
        }

        return `
          <article class="relative rounded-xl shadow-xl bg-gray-800/80 backdrop-blur-sm text-gray-100 transform hover:scale-[1.01] transition-transform duration-300">
            <header class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-600 bg-gray-900/50 rounded-t-xl">
              <h2 class="text-base sm:text-lg font-semibold text-amber-400">
                ${showVerified ? 'Verified' : 'Registration'} — ${date}
              </h2>
            </header>
            <div class="grid grid-cols-1 sm:grid-cols-2">
              <section class="p-4 sm:p-6 sm:border-r border-gray-600">
                <h3 class="mb-3 text-base sm:text-lg font-semibold text-amber-400 pb-1 border-b-2 border-amber-400 w-max">Personal Info</h3>
                <table class="w-full text-xs sm:text-sm divide-y divide-gray-600 rounded-lg">
                  <tbody>${Object.entries(P).map(([k, v]) => field(k, v)).join('')}</tbody>
                </table>
              </section>
              <section class="p-4 sm:p-6">
                <h3 class="mb-3 text-base sm:text-lg font-semibold text-amber-400 pb-1 border-b-2 border-amber-400 w-max">Institute Info</h3>
                <table class="w-full text-xs sm:text-sm divide-y divide-gray-600 rounded-lg">
                  <tbody>${Object.entries(I).map(([k, v]) => field(k, v)).join('')}</tbody>
                </table>
              </section>
            </div>
            ${extraContent}
          </article>`;
      }).join('');
    }

    async function verifyReg(id) {
      try {
        const res = await fetch(`/admin/verify/${id}`, {
          method: 'GET',
          headers: { ...hdr(), 'Content-Type': 'application/json' }
        });

        if (!res.ok) {
          alert('Verification failed. Please try again.');
          return;
        }

        const data = await res.json();
        const { instituteId, superAdminId, password } = data;

        alert(`✅ Verification Successful!\n\nInstitute ID: ${instituteId}\nSuper Admin ID: ${superAdminId}\nPassword: ${password}`);
        await load(isShowingVerified);
      } catch (err) {
        console.error('Verification Error:', err);
        alert('An error occurred during verification.');
      }
    }

    function logout() {
      localStorage.removeItem('sms_admin_creds');
      location.href = '/admin/login';
    }

    let selectedIdForDelete = null;

    function openDeleteModal(id) {
      selectedIdForDelete = id;
      const err = document.getElementById('passError');
      err.textContent = '';
      err.classList.add('hidden');
      document.getElementById('adminPass').value = '';
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeModal() {
      selectedIdForDelete = null;
      document.getElementById('deleteModal').classList.add('hidden');
    }

    async function confirmDelete() {
      const password = document.getElementById('adminPass').value.trim();
      const errorEl = document.getElementById('passError');

      if (!password) {
        errorEl.textContent = 'Please enter password.';
        errorEl.classList.remove('hidden');
        setTimeout(() => errorEl.classList.add('hidden'), 3000);
        return;
      }

      const res = await fetch('/admin/verify-password', {
        method: 'POST',
        headers: { ...hdr(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      const data = await res.json();

      if (!res.ok || !data.success) {
        errorEl.textContent = 'Invalid password. Please try again.';
        errorEl.classList.remove('hidden');
        setTimeout(() => errorEl.classList.add('hidden'), 3000);
        return;
      }

      const r = await fetch('/admin/delete/' + selectedIdForDelete, {
        method: 'DELETE',
        headers: { ...hdr(), 'Content-Type': 'application/json' }
      });

      if (r.ok) {
        errorEl.classList.add('hidden');
        closeModal();
        load();
      } else {
        errorEl.textContent = 'Deletion failed. Please try again.';
        errorEl.classList.remove('hidden');
        setTimeout(() => errorEl.classList.add('hidden'), 3000);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('sms_admin_creds');
      if (!token) {
        location.href = '/admin/login';
        return;
      }

      load();
      document.getElementById('toggleBtn').addEventListener('click', () => load(!isShowingVerified));
    });
  </script>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
    <div class="bg-gray-800/90 rounded-xl p-6 sm:p-8 w-full max-w-md shadow-2xl backdrop-blur-sm space-y-6">
      <h2 class="text-xl sm:text-2xl font-semibold text-red-500 tracking-tight">Delete Registration</h2>
      <p class="text-xs sm:text-sm text-gray-300">This action cannot be undone. Please enter the admin password to continue.</p>
      <input id="adminPass" type="password" class="w-full px-4 py-2 border border-gray-600 rounded-full bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-amber-400 text-sm sm:text-base" placeholder="Enter admin password" />
      <p id="passError" class="text-red-500 text-xs sm:text-sm mt-1 hidden"></p>
      <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6">
        <button onclick="closeModal()" class="px-4 sm:px-5 py-2 bg-gray-600 text-white rounded-full hover:bg-gray-500 transition-all font-semibold text-sm sm:text-base">
          Cancel
        </button>
        <button onclick="confirmDelete()" class="px-4 sm:px-5 py-2 bg-red-600 text-white rounded-full hover:bg-red-500 transition-all font-semibold text-sm sm:text-base">
          Confirm Delete
        </button>
      </div>
    </div>
  </div>
</body>
</html>