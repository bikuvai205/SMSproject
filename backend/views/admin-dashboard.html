<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin - Registrations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-900 dark:to-gray-800 p-8">
  <div class="max-w-6xl mx-auto space-y-4">
    <h1 class="text-3xl font-semibold text-center text-gray-800 dark:text-gray-100 
             bg-gradient-to-r from-amber-400/20 via-transparent to-amber-400/20 
             rounded-lg py-3 px-6">
      Registrations Dashboard
    </h1>

    <div class="flex justify-between items-center mb-4 px-2">
      <div id="totalCount" class="font-semibold text-amber-700 dark:text-amber-400 text-lg">
        <!-- Total will be set via JS -->
      </div>
      <button onclick="logout()"
        class="flex items-center gap-2 px-4 py-1.5 text-sm font-medium rounded-lg 
               bg-amber-500 text-white hover:bg-amber-600 active:bg-amber-700 
               dark:bg-amber-400 dark:text-gray-900 dark:hover:bg-amber-300 
               shadow transition-all duration-200">
        Logout
      </button>
    </div>

    <div id="tableWrapper" class="space-y-10"></div>
  </div>

  <script>
  const hdr = () => {
    const tok = localStorage.getItem('sms_admin_creds');
    return tok ? { Authorization: `Basic ${tok}` } : {};
  };

  const field = (k, v) => `
    <tr class="divide-x divide-gray-200 dark:divide-gray-600">
      <td class="py-2 px-4 font-medium text-gray-700 dark:text-gray-300">${k}</td>
      <td class="py-2 px-4 text-gray-900 dark:text-gray-100 break-words">${v ?? '-'}</td>
    </tr>`;

  async function load() {
    const r = await fetch('/admin/data', { headers: hdr() });
    if (r.status === 401) return (location.href = '/admin/login');

    const regs = await r.json();
    document.getElementById('totalCount').textContent = `Total Registrations: ${regs.length}`;
    const wrap = document.getElementById('tableWrapper');
    if (!regs.length) return wrap.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No registrations yet.</p>';

    wrap.innerHTML = regs.map(rec => {
      const P = {
        'Full Name': rec.fullName, 'Role': rec.role, 'Address': rec.address,
        'Email': rec.email, 'Phone': rec.phone, 'Citizen Doc': rec.citizenDoc
      };
      const I = {
        'Institute': rec.institutionName, 'Type': rec.institutionType, 'PAN / VAT': rec.panVat,
        'Address': rec.institutionAddress, 'Email': rec.institutionEmail,
        'Contact': rec.institutionContact, 'Additional': rec.additionalInfo
      };
      const date = new Date(rec.createdAt || parseInt(rec._id.slice(0, 8), 16) * 1000).toLocaleString();

      return `
<article class="relative card overflow-hidden">
  <span class="accent-bar"></span>
  <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-white/60 dark:bg-gray-800/60 rounded-t-2xl">
    <h2 class="text-lg font-semibold text-amber-600">Registration — ${date}</h2>
    <div class="flex gap-4">
      <button class="px-3 py-1 rounded-md bg-green-600 hover:bg-green-700 text-white text-sm"
              onclick="verifyReg('${rec._id}')">Verify</button>
      <button class="px-3 py-1 rounded-md bg-red-600 hover:bg-red-700 text-white text-sm"
              onclick="openDeleteModal('${rec._id}')">Remove</button>
    </div>
  </header>
  <div class="grid md:grid-cols-2">
    <section class="p-6 bg-[#1C2533] border-r border-gray-200 dark:border-gray-700">
      <h3 class="mb-3 text-lg font-semibold text-gray-100 pb-1 border-b-2 border-amber-500 w-max">Personal Info</h3>
      <table class="w-full text-sm zebra divide-y divide-gray-200 dark:divide-gray-600 rounded-lg overflow-hidden">
        <tbody>${Object.entries(P).map(([k, v]) => field(k, v)).join('')}</tbody>
      </table>
    </section>
    <section class="p-6 bg-[#1C2533]">
      <h3 class="mb-3 text-lg font-semibold text-gray-100 pb-1 border-b-2 border-amber-500 w-max">Institute Info</h3>
      <table class="w-full text-sm zebra divide-y divide-gray-200 dark:divide-gray-600 rounded-lg overflow-hidden">
        <tbody>${Object.entries(I).map(([k, v]) => field(k, v)).join('')}</tbody>
      </table>
    </section>
  </div>
</article>`;
    }).join('');
  }

 // ─── VERIFY ────────────────────────────────────────────────────────────────
async function verifyReg(id) {
  try {
    const res = await fetch(`/admin/verify/${id}`, {
      method: 'GET',
      headers: { ...hdr(), 'Content-Type': 'application/json' }
    });

    if (!res.ok) {
      alert('Verification failed. Please try again.');
      return;
    }

    const data = await res.json();
    const { instituteId, superAdminId, password } = data;

    alert(`✅ Verification Successful!\n\nInstitute ID: ${instituteId}\nSuper Admin ID: ${superAdminId}\nPassword: ${password}`);
  } catch (err) {
    console.error('Verification Error:', err);
    alert('An error occurred during verification.');
  }
}


  function logout() {
    localStorage.removeItem('sms_admin_creds');
    location.href = '/admin/login';
  }

  const token = localStorage.getItem('sms_admin_creds');
  if (!token) {
    location.href = '/admin/login';
  } else {
    window.addEventListener('DOMContentLoaded', load);
  }

  let selectedIdForDelete = null;

  function openDeleteModal(id) {
    selectedIdForDelete = id;
    const err = document.getElementById('passError');
    err.textContent = '';
    err.classList.add('hidden');
    document.getElementById('adminPass').value = '';
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeModal() {
    selectedIdForDelete = null;
    document.getElementById('deleteModal').classList.add('hidden');
  }

  async function confirmDelete() {
    const password = document.getElementById('adminPass').value.trim();
    const errorEl = document.getElementById('passError');

    if (!password) {
      errorEl.textContent = 'Please enter password.';
      errorEl.classList.remove('hidden');
      setTimeout(() => errorEl.classList.add('hidden'), 3000);
      return;
    }

    const res = await fetch('/admin/verify-password', {
      method: 'POST',
      headers: { ...hdr(), 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      errorEl.textContent = 'Invalid password. Please try again.';
      errorEl.classList.remove('hidden');
      setTimeout(() => errorEl.classList.add('hidden'), 3000);
      return;
    }

    const r = await fetch('/admin/delete/' + selectedIdForDelete, {
      method: 'DELETE',
      headers: { ...hdr(), 'Content-Type': 'application/json' }
    });

    if (r.ok) {
      errorEl.classList.add('hidden');
      closeModal();
      load();
    } else {
      errorEl.textContent = 'Deletion failed. Please try again.';
      errorEl.classList.remove('hidden');
      setTimeout(() => errorEl.classList.add('hidden'), 3000);
    }
  }
</script>

  <!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md shadow-lg relative space-y-4">
    <h2 class="text-xl font-semibold text-red-600">Delete Registration</h2>
    <p class="text-sm text-gray-700 dark:text-gray-300">This action cannot be undone. Please enter the admin password to continue.</p>

    <input id="adminPass" type="password"
           class="w-full px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-700 dark:text-white"
           placeholder="Enter admin password" />
<p id="passError" class="text-red-600 text-sm mt-1 hidden"></p>
    <div class="flex justify-end gap-2 mt-4">
      <button onclick="closeModal()"
              class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-900 dark:text-white rounded hover:bg-gray-400">
        Cancel
      </button>
      <button onclick="confirmDelete()"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
        Confirm Delete
      </button>
    </div>
  </div>
</div>

</body>

</html>
